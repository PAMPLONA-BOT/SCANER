<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>App de Reportes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --bg-color: #e9ecef;
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--dark-color);
        }
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 20px;
        }
        .card-title {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 15px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-info { background-color: var(--info-color); color: white; }
        .btn-full { grid-column: 1 / -1; }
        
        #selectedFilesList { list-style: none; padding: 0; margin-top: 15px; font-size: 0.9em; }
        #selectedFilesList li { background-color: var(--light-color); padding: 10px; border-radius: 6px; margin-bottom: 5px; }

        .input-group { margin-bottom: 15px; }
        .input-group label { font-weight: 600; display: block; margin-bottom: 8px; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; }
        .input-group-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 1000; }
        .modal-container { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; transform: translateY(-30px); transition: all 0.3s ease; }
        .modal-overlay.is-active { opacity: 1; visibility: visible; }
        .modal-overlay.is-active .modal-container { transform: translateY(0); }
        .modal-title { font-size: 1.4em; text-align: center; margin-top: 0; }
        .modal-actions { display: flex; flex-direction: column; gap: 15px; margin: 25px 0; }
        .modal-separator { text-align: center; font-size: 0.9em; color: #888; margin: 20px 0 10px; }

        /* --- NEW & UPDATED HISTORY STYLES --- */
        .history-group details {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #fff;
        }
        .history-group summary {
            font-weight: bold;
            font-size: 1.1em;
            padding: 15px;
            cursor: pointer;
            list-style: none;
            display: flex;
            align-items: center;
        }
        .history-group summary::-webkit-details-marker { display: none; }
        .history-group summary:before {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-right: 12px;
            transition: transform 0.2s;
            font-size: 0.9em;
        }
        .history-group details[open] > summary:before { transform: rotate(180deg); }

        .history-group-nested {
            padding: 0 15px 10px 15px;
        }
        .history-group-nested details {
             border-color: #e9ecef;
             background-color: #f8f9fa;
        }
        .history-group-nested summary {
            font-size: 1em;
            padding: 12px 15px;
        }
        .history-group-nested .history-group-nested { /* Day level */
            padding-left: 0;
            padding-right: 0;
            padding-bottom: 5px;
        }
         .history-group-nested .history-group-nested summary {
             font-size: 0.9em;
             background-color: #fdfdff;
             font-weight: normal;
             padding: 10px 15px;
         }

        .history-item-container { padding: 0 15px 15px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; background: #fff; border-bottom: 1px solid #eee; padding: 12px 5px; }
        .history-item:last-child { border-bottom: none; }
        .history-info { flex-grow: 1; margin-right: 10px; }
        .history-info span { display: block; }
        .history-info .name { font-weight: 600; }
        .history-info .date { font-size: 0.8em; color: #666; }
        .history-actions { display: flex; gap: 10px; }
        .history-actions .btn { padding: 8px 12px; font-size: 0.9em; border-radius: 6px; width: auto; }
        .history-share-btn { background-color: var(--primary-color); color: white; }
        .history-dl-btn { background-color: #6c757d; color: white; }

        .loader { display: inline-block; border: 4px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- CARD 0: TYPE SELECTION -->
        <div class="card" id="typeSelectionCard">
            <h2 class="card-title">0. Seleccionar Tipo de Reporte</h2>
            <div class="modal-actions">
                <button class="btn btn-primary type-btn" data-type="RECONEXION"><i class="fa-solid fa-plug-circle-check"></i> Reconexión</button>
                <button class="btn btn-info type-btn" data-type="CHARLA SEMANAL"><i class="fa-solid fa-people-group"></i> Charla Semanal</button>
                <button class="btn btn-dark type-btn" data-type="FORMACIONES"><i class="fa-solid fa-chalkboard-user"></i> Formaciones</button>
            </div>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- CARD 1: INPUTS -->
            <div class="card" id="prepareCard">
                <h2 class="card-title">1. Preparar Documentos 
                    <button id="changeTypeBtn" style="font-size: 0.6em; padding: 5px 10px; border-radius: 5px; background: #6c757d; color: white; border: none; cursor: pointer;">Cambiar Tipo</button>
                </h2>
                <div id="charlaInputs" class="input-group" style="display:none;">
                    <label>Rango de fechas para la charla:</label>
                    <div class="input-group-grid"> <input type="date" id="charlaStartDate"> <input type="date" id="charlaEndDate"> </div>
                </div>
                <div id="formacionesInputs" class="input-group" style="display:none;">
                     <label>Datos de la Formación:</label>
                     <div class="input-group-grid"> <input type="number" id="formacionNumero" placeholder="3 Números"> <input type="text" id="formacionTexto" placeholder="Texto adicional"> </div>
                </div>
                <div class="input-group">
                    <label for="pdfNameInput">Nombre del Reporte:</label>
                    <input type="text" id="pdfNameInput" placeholder="Se generará automáticamente...">
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" id="captureBtn"><i class="fa-solid fa-camera"></i> Tomar Foto</button>
                    <button class="btn btn-primary" id="selectBtn"><i class="fa-solid fa-images"></i> Seleccionar</button>
                    <input type="file" id="captureInput" multiple accept="image/*" capture="environment" style="display:none;">
                    <input type="file" id="selectInput" multiple accept="image/*" style="display:none;">
                </div>
                <div id="selectionInfo" style="display:none;">
                    <h4>Archivos en cola:</h4> <ul id="selectedFilesList"></ul>
                    <button class="btn btn-danger btn-full" id="clearSelectionBtn"><i class="fa-solid fa-trash"></i> Limpiar Selección</button>
                </div>
            </div>

            <!-- CARD 2: ACTION -->
            <div class="card" id="generateCard">
                 <h2 class="card-title">2. Generar y Enviar</h2>
                 <button class="btn btn-secondary btn-full" id="generateButton" disabled> <i class="fa-solid fa-file-pdf"></i> Generar PDF </button>
                 <div id="status" style="text-align: center; margin-top: 15px; font-weight: 600;"></div>
            </div>

            <!-- CARD 3: HISTORY -->
            <div class="card" id="historyCard">
                <h2 class="card-title">Historial de Envíos</h2>
                <div id="historyContainer"><p>Cargando...</p></div>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE COMPARTIR HÍBRIDO -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal-container">
            <h3 class="modal-title">¡PDF Generado!</h3>
            <p style="text-align:center; color: #555;">Elige cómo quieres compartirlo:</p>
            <div class="modal-actions">
                <button class="btn btn-primary" id="modalNativeShare"><i class="fa-solid fa-share-nodes"></i> Compartir...</button>
                <div class="modal-separator" id="modalSeparator">o usa una acción específica:</div>
                <button class="btn btn-secondary" id="modalWhatsapp"><i class="fa-brands fa-whatsapp"></i> Enviar a WhatsApp</button>
                <button class="btn" style="background-color: #0072C6; color: white;" id="modalEmail"><i class="fa-solid fa-envelope"></i> Enviar Correo (Reconexión)</button>
                <button class="btn" style="background-color: #6c757d; color: white;" id="modalDownload"><i class="fa-solid fa-download"></i> Solo Descargar</button>
            </div>
            <button class="btn" style="background-color: #dc3545; color: white;" id="modalClose">Cerrar</button>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const CORREO_DESTINO = "cgo.cens@consorcioci.co";
        const DB_NAME = "ReconexionesDB_v3";
        const DB_VERSION = 2; 
        const STORE_NAME = "pdfs";
        const { jsPDF } = window.jspdf;
        let db;
        let selectedFiles = [];
        let generatedPdfBlob = null;
        let generatedPdfName = '';
        let currentDocumentType = null;
        let nativeShareSupported = false;

        // --- DOM ELEMENTS ---
        const typeSelectionCard = document.getElementById('typeSelectionCard');
        const mainContent = document.getElementById('mainContent');
        const typeButtons = document.querySelectorAll('.type-btn');
        const changeTypeBtn = document.getElementById('changeTypeBtn');
        const charlaInputs = document.getElementById('charlaInputs');
        const charlaStartDate = document.getElementById('charlaStartDate');
        const charlaEndDate = document.getElementById('charlaEndDate');
        const formacionesInputs = document.getElementById('formacionesInputs');
        const formacionNumero = document.getElementById('formacionNumero');
        const formacionTexto = document.getElementById('formacionTexto');
        const captureBtn = document.getElementById('captureBtn');
        const selectBtn = document.getElementById('selectBtn');
        const clearSelectionBtn = document.getElementById('clearSelectionBtn');
        const captureInput = document.getElementById('captureInput');
        const selectInput = document.getElementById('selectInput');
        const selectionInfo = document.getElementById('selectionInfo');
        const selectedFilesList = document.getElementById('selectedFilesList');
        const pdfNameInput = document.getElementById('pdfNameInput');
        const generateButton = document.getElementById('generateButton');
        const statusDiv = document.getElementById('status');
        const historyContainer = document.getElementById('historyContainer');
        const shareModal = document.getElementById('shareModal');
        const modalNativeShare = document.getElementById('modalNativeShare');
        const modalSeparator = document.getElementById('modalSeparator');
        const modalDownload = document.getElementById('modalDownload');
        const modalWhatsapp = document.getElementById('modalWhatsapp');
        const modalEmail = document.getElementById('modalEmail');
        const modalClose = document.getElementById('modalClose');

        // --- DB LOGIC ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => reject("Error al abrir IndexedDB.");
                request.onsuccess = (event) => { db = event.target.result; resolve(); };
                request.onupgradeneeded = (event) => {
                    let db = event.target.result;
                    let store;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    } else {
                        store = event.target.transaction.objectStore(STORE_NAME);
                    }
                    if (!store.indexNames.contains('fecha')) {
                        store.createIndex('fecha', 'fecha', { unique: false });
                    }
                    if (!store.indexNames.contains('tipo')) {
                        store.createIndex('tipo', 'tipo', { unique: false });
                    }
                };
            });
        }
        
        // --- UI FLOW & NAMING LOGIC ---
        function showTypeSelection() {
            mainContent.style.display = 'none';
            typeSelectionCard.style.display = 'block';
            currentDocumentType = null;
            clearSelectionBtn.click();
            pdfNameInput.value = '';
        }
        
        function showMainContent(type) {
            currentDocumentType = type;
            typeSelectionCard.style.display = 'none';
            mainContent.style.display = 'block';
            charlaInputs.style.display = 'none';
            formacionesInputs.style.display = 'none';
            switch(type) {
                case 'RECONEXION':
                    const hoy = new Date().toLocaleDateString('es-CO');
                    pdfNameInput.value = `RECONEXION A PAPEL PAMPLONA ${hoy}`;
                    break;
                case 'CHARLA SEMANAL':
                    charlaInputs.style.display = 'block';
                    updateCharlaName();
                    break;
                case 'FORMACIONES':
                    formacionesInputs.style.display = 'block';
                    updateFormacionesName();
                    break;
            }
        }

        function updateCharlaName() {
            const start = charlaStartDate.value;
            const end = charlaEndDate.value;
            if (start && end) {
                const startDate = new Date(start + 'T00:00:00');
                const endDate = new Date(end + 'T00:00:00');
                const startStr = startDate.toLocaleDateString('es-CO', { day: '2-digit', month: 'long' });
                const endStr = endDate.toLocaleDateString('es-CO', { day: '2-digit', month: 'long', year: 'numeric'});
                pdfNameInput.value = `CHARLA SEMANAL del ${startStr} al ${endStr}`;
            } else {
                pdfNameInput.value = 'CHARLA SEMANAL (selecciona fechas)';
            }
        }

        function updateFormacionesName() {
            const num = formacionNumero.value || 'XXX';
            const txt = formacionTexto.value || 'descripción';
            pdfNameInput.value = `PAM${num}-${txt}`;
        }

        // --- FILE HANDLING ---
        function handleFileSelection(event) {
            const newFiles = Array.from(event.target.files);
            if (selectedFiles.length + newFiles.length > 10) {
                alert("Puedes seleccionar un máximo de 10 archivos en total.");
                return;
            }
            selectedFiles.push(...newFiles);
            updateSelectedFilesUI();
        }

        function updateSelectedFilesUI() {
            if (selectedFiles.length === 0) {
                selectionInfo.style.display = 'none';
                generateButton.disabled = true;
            } else {
                selectionInfo.style.display = 'block';
                selectedFilesList.innerHTML = selectedFiles.map(f => `<li>${f.name}</li>`).join('');
                generateButton.disabled = false;
            }
        }

        // --- PDF GENERATION ---
        generateButton.addEventListener('click', async () => {
            if (!pdfNameInput.value.trim() || pdfNameInput.value.includes('(selecciona') || pdfNameInput.value.includes('XXX')) {
                alert("Por favor, completa los datos para el nombre del reporte.");
                return;
            }
            generateButton.disabled = true;
            generateButton.innerHTML = '<span class="loader"></span> Procesando...';
            statusDiv.textContent = `Creando PDF...`;
            try {
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                for (let i = 0; i < selectedFiles.length; i++) {
                    statusDiv.textContent = `Agregando imagen ${i + 1} de ${selectedFiles.length}...`;
                    const imageData = await readFileAsDataURL(selectedFiles[i]);
                    const imgProps = await getImageProperties(imageData);
                    const { pdfWidth, pdfHeight } = { pdfWidth: pdf.internal.pageSize.getWidth(), pdfHeight: pdf.internal.pageSize.getHeight() };
                    const ratio = Math.min((pdfWidth - 20) / imgProps.width, (pdfHeight - 20) / imgProps.height);
                    const [imgWidth, imgHeight] = [imgProps.width * ratio, imgProps.height * ratio];
                    const [x, y] = [(pdfWidth - imgWidth) / 2, (pdfHeight - imgHeight) / 2];
                    if (i > 0) pdf.addPage();
                    pdf.addImage(imageData, null, x, y, imgWidth, imgHeight);
                }
                generatedPdfName = pdfNameInput.value.trim();
                generatedPdfBlob = pdf.output('blob');
                await agregarAlHistorial(generatedPdfName, generatedPdfBlob, currentDocumentType);
                await mostrarHistorial();
                statusDiv.textContent = "¡PDF Listo!";
                showShareOptionsModal();
            } catch (error) {
                console.error("Error al generar PDF:", error);
                statusDiv.textContent = "Error al generar el PDF.";
                alert("Ocurrió un error al procesar las imágenes.");
            } finally {
                generateButton.disabled = false;
                generateButton.innerHTML = '<i class="fa-solid fa-file-pdf"></i> Generar PDF';
            }
        });
        
        // --- SHARING LOGIC (HÍBRIDA) ---
        function showShareOptionsModal() {
            modalNativeShare.style.display = nativeShareSupported ? 'flex' : 'none';
            modalSeparator.style.display = nativeShareSupported ? 'block' : 'none';
            modalEmail.style.display = (currentDocumentType === 'RECONEXION') ? 'flex' : 'none';
            shareModal.classList.add('is-active'); 
        }

        async function triggerNativeShare(blob, name) {
            const pdfFile = new File([blob], `${name}.pdf`, { type: 'application/pdf' });
            const shareData = {
                files: [pdfFile],
                title: name,
                text: `Se adjunta el documento: ${name}`
            };
            try {
                await navigator.share(shareData);
            } catch (error) {
                if (error.name !== 'AbortError') console.error('Error al compartir:', error);
            }
        }

        // --- LISTENERS DEL MODAL ---
        modalNativeShare.addEventListener('click', () => {
            triggerNativeShare(generatedPdfBlob, generatedPdfName).finally(closeModal);
        });
        modalClose.addEventListener('click', closeModal);
        modalDownload.addEventListener('click', () => {
            downloadBlob(generatedPdfBlob, `${generatedPdfName}.pdf`);
            closeModal();
        });
        modalWhatsapp.addEventListener('click', () => {
            const mensaje = encodeURIComponent(`Se comparte el documento: ${generatedPdfName}`);
            window.open(`https://api.whatsapp.com/send?text=${mensaje}`, '_blank');
            setTimeout(() => downloadBlob(generatedPdfBlob, `${generatedPdfName}.pdf`), 500);
            closeModal();
        });
        modalEmail.addEventListener('click', () => {
            const cc = "diego.medina@inmel.co,edgar.mendoza@inmel.co,NELSON.CARVAJAL@cens.com.co";
            const asunto = encodeURIComponent("RECONEXIONES A PAPEL");
            const firmaTexto = `\n\n\nCordialmente.\n\nSupervisión Pamplona\nProyecto CENS Comercial\nsupervisionpamplona.cens@consorcioci.co\nDirección: Carera 8 # 4-80\nPBX: (57 7) 595 5345\nPamplona - Norte de Santander`;
            const cuerpo = encodeURIComponent(`Buen día.\n\nAdjunto archivo correspondiente a reconexiones en papel ejecutadas, para que por favor me colabore con el ingreso en el sistema.\n\nQuedo atento.${firmaTexto}`);
            window.open(`mailto:${CORREO_DESTINO}?cc=${cc}&subject=${asunto}&body=${cuerpo}`, '_blank');
            setTimeout(() => downloadBlob(generatedPdfBlob, `${generatedPdfName}.pdf`), 500);
            closeModal();
        });
        function closeModal() { shareModal.classList.remove('is-active'); }

        // --- HISTORY LOGIC ---
        async function agregarAlHistorial(nombre, pdfBlob, tipo) {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            return new Promise((resolve, reject) => {
                const request = store.add({ nombre, fecha: new Date(), pdfBlob, tipo });
                request.onsuccess = resolve;
                request.onerror = reject;
            });
        }

        async function mostrarHistorial() {
            await limpiarHistorialAntiguo();
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onerror = () => { historyContainer.innerHTML = "<p>Error al cargar el historial.</p>"; };
            
            request.onsuccess = (event) => {
                const historial = event.target.result;
                if (historial.length === 0) {
                    historyContainer.innerHTML = "<p>No hay envíos guardados.</p>";
                    return;
                }

                // Agrupación jerárquica: Tipo -> Mes -> Día
                const grouped = historial.reduce((acc, item) => {
                    const tipo = item.tipo || 'Sin Categoría';
                    const fecha = new Date(item.fecha);
                    const monthKey = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                    const dayKey = `${monthKey}-${String(fecha.getDate()).padStart(2, '0')}`;

                    if (!acc[tipo]) acc[tipo] = {};
                    if (!acc[tipo][monthKey]) acc[tipo][monthKey] = {};
                    if (!acc[tipo][monthKey][dayKey]) acc[tipo][monthKey][dayKey] = [];
                    acc[tipo][monthKey][dayKey].push(item);
                    return acc;
                }, {});

                let html = '<div class="history-group">';
                
                // Nivel 1: Tipo de Documento
                for (const tipo in grouped) {
                    const tipoNombres = { 'RECONEXION': 'Reconexiones', 'CHARLA SEMANAL': 'Charlas Semanales', 'FORMACIONES': 'Formaciones' };
                    const tipoNombre = tipoNombres[tipo] || tipo;
                    const totalItemsPorTipo = Object.values(grouped[tipo]).flatMap(days => Object.values(days)).flat().length;

                    html += `<details><summary>${tipoNombre} (${totalItemsPorTipo})</summary><div class="history-group-nested">`;
                    
                    // Nivel 2: Mes
                    const meses = grouped[tipo];
                    const sortedMonthKeys = Object.keys(meses).sort().reverse();
                    for(const monthKey of sortedMonthKeys) {
                        const totalItemsPorMes = Object.values(meses[monthKey]).flat().length;
                        const [year, month] = monthKey.split('-');
                        const monthName = new Date(year, month - 1, 1).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                        
                        html += `<details><summary class="month-summary">${monthName.charAt(0).toUpperCase() + monthName.slice(1)} (${totalItemsPorMes})</summary><div class="history-group-nested">`;

                        // Nivel 3: Día
                        const dias = meses[monthKey];
                        const sortedDayKeys = Object.keys(dias).sort().reverse();
                        for(const dayKey of sortedDayKeys) {
                            const itemsDelDia = dias[dayKey];
                            const [dYear, dMonth, dDay] = dayKey.split('-');
                            const dayName = new Date(dYear, dMonth-1, dDay).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' });

                            html += `<details><summary class="day-summary">${dayName.charAt(0).toUpperCase() + dayName.slice(1)} (${itemsDelDia.length})</summary><div class="history-item-container">`;
                            
                            // Renderizar items
                            html += itemsDelDia.sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).map(item => `
                                <div class="history-item">
                                    <div class="history-info">
                                        <span class="name">${item.nombre}</span>
                                        <span class="date">${new Date(item.fecha).toLocaleString('es-ES')}</span>
                                    </div>
                                    <div class="history-actions">
                                        ${nativeShareSupported ? `<button class="btn history-share-btn" data-id="${item.id}"><i class="fa-solid fa-share-nodes"></i></button>` : ''}
                                        <button class="btn history-dl-btn" data-id="${item.id}"><i class="fa-solid fa-download"></i></button>
                                    </div>
                                </div>`).join('');
                            
                            html += `</div></details>`; // Cierre día
                        }
                        html += `</div></details>`; // Cierre mes
                    }
                    html += `</div></details>`; // Cierre tipo
                }
                html += '</div>';
                historyContainer.innerHTML = html;
            };
        }

        historyContainer.addEventListener('click', (event) => {
            const dlBtn = event.target.closest('.history-dl-btn');
            if (dlBtn) { const id = Number(dlBtn.dataset.id); descargarDesdeHistorial(id); }

            const shareBtn = event.target.closest('.history-share-btn');
            if (shareBtn) { const id = Number(shareBtn.dataset.id); shareFromHistory(id); }
        });
        function descargarDesdeHistorial(id) {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(id);
            request.onsuccess = (event) => {
                const record = event.target.result;
                if (record && record.pdfBlob) { downloadBlob(record.pdfBlob, `${record.nombre}.pdf`); }
            };
        }
        async function shareFromHistory(id) {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(id);
            request.onsuccess = (event) => {
                const record = event.target.result;
                if (record && record.pdfBlob) { triggerNativeShare(record.pdfBlob, record.nombre); }
            };
        }
        function downloadBlob(blob, filename) {
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = filename;
             document.body.appendChild(a);
             a.click();
             a.remove();
             URL.revokeObjectURL(url);
        }
        function limpiarHistorialAntiguo() {
            return new Promise((resolve, reject) => {
                const tresMesesAtras = new Date();
                tresMesesAtras.setMonth(tresMesesAtras.getMonth() - 3);
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const index = store.index('fecha');
                const request = index.openCursor(IDBKeyRange.upperBound(tresMesesAtras));
                request.onsuccess = event => { const cursor = event.target.result; if (cursor) { cursor.delete(); cursor.continue(); } else { resolve(); } };
                request.onerror = reject;
            });
        }

        // --- HELPER FUNCTIONS ---
        const readFileAsDataURL = file => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(file); });
        const getImageProperties = src => new Promise((resolve, reject) => { const img = new Image(); img.onload = () => resolve({ width: img.width, height: img.height }); img.onerror = reject; img.src = src; });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            nativeShareSupported = !!(navigator.share && navigator.canShare);
            try {
                await initDB();
                await mostrarHistorial();
            } catch (error) {
                console.error(error);
                historyContainer.innerHTML = `<p style="color:red;">Error al cargar el historial.</p>`;
            }
            showTypeSelection();
            updateSelectedFilesUI();
        });

        // --- EVENT LISTENERS UI ---
        typeButtons.forEach(btn => btn.addEventListener('click', () => showMainContent(btn.dataset.type))); 
        changeTypeBtn.addEventListener('click', showTypeSelection); 
        charlaStartDate.addEventListener('change', updateCharlaName); 
        charlaEndDate.addEventListener('change', updateCharlaName); 
        formacionNumero.addEventListener('input', updateFormacionesName); 
        formacionTexto.addEventListener('input', updateFormacionesName);
        captureBtn.addEventListener('click', () => captureInput.click()); 
        selectBtn.addEventListener('click', () => selectInput.click()); 
        captureInput.addEventListener('change', handleFileSelection); 
        selectInput.addEventListener('change', handleFileSelection);
        clearSelectionBtn.addEventListener('click', () => { 
            selectedFiles = []; 
            captureInput.value = ''; 
            selectInput.value = ''; 
            updateSelectedFilesUI(); 
        });
    </script>
</body>
</html>
