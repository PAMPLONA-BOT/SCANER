<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gestor de Reportes Pro</title>
    <!-- Librerías Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #198754;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --bg-color: #f0f2f5;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.07);
        }
        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--dark-color);
        }
        
        .app-header {
            background: white;
            color: var(--dark-color);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .app-header-title { margin: 0; font-size: 1.2em; font-weight: 700; }
        .app-header-subtitle { font-size: 0.8em; color: #6c757d; }
        #changeTypeBtn {
            background: var(--light-color);
            color: var(--dark-color);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: background 0.2s;
        }
        #changeTypeBtn:hover { background-color: #e2e6ea; }

        .app-container { max-width: 700px; margin: 0 auto; padding: 20px; }
        
        #typeSelectionCard { padding: 30px; }
        .type-selection-grid {
            display: grid;
            gap: 20px;
            margin-top: 25px;
        }
        .type-tile {
            background: var(--light-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .type-tile:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }
        .type-tile .icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        .type-tile h3 { margin: 0 0 5px 0; font-size: 1.2em; }
        .type-tile p { margin: 0; color: #6c757d; font-size: 0.9em; }


        .card {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 5px 20px var(--shadow-color);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        .card-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--dark-color);
            margin: 0 0 25px 0;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .btn {
            display: flex; align-items: center; justify-content: center; gap: 12px;
            width: 100%; padding: 16px; font-size: 1.05em; font-weight: 600;
            border: none; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        
        #filePreviewContainer { display: none; margin-top: 25px; }
        .file-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; }
        .preview-item { position: relative; border-radius: 12px; overflow: hidden; border: 2px solid var(--border-color); height: 110px; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .preview-item .remove-btn {
            position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,0.6);
            color: white; border: none; border-radius: 50%; width: 28px; height: 28px;
            font-size: 0.9em; cursor: pointer; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(2px);
        }
        .input-group { margin-bottom: 20px; }
        .input-group label { font-weight: 600; display: block; margin-bottom: 8px; color: #495057; }
        .input-group input { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1em; }
        .input-group-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* --- ESTILOS DE HISTORIAL --- */
        .history-group details { border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 10px; background-color: #fff; transition: box-shadow 0.2s; }
        .history-group details[open] { box-shadow: 0 4px 15px var(--shadow-color); }
        .history-group summary { font-weight: 600; font-size: 1.1em; padding: 18px; cursor: pointer; list-style: none; display: flex; align-items: center; }
        .history-group summary::-webkit-details-marker { display: none; }
        .history-group summary:before { content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900; margin-right: 15px; transition: transform 0.2s; color: var(--primary-color); }
        .history-group details[open] > summary:before { transform: rotate(180deg); }

        .history-group-nested { padding: 0 15px 10px 15px; }
        .history-group-nested details { border-color: #e9ecef; background-color: #f8f9fa; }
        .history-group-nested summary { font-size: 1em; padding: 12px 15px; }
        
        .history-item-container { padding: 0 15px 15px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; background: #fff; border-bottom: 1px solid #eee; padding: 15px 5px; }
        .history-item:last-child { border-bottom: none; }
        .history-info .name { font-weight: 600; }
        .history-info .date { font-size: 0.85em; color: #666; margin-top: 4px; }
        .history-actions { display: flex; gap: 10px; }
        .history-actions .btn { padding: 8px 12px; font-size: 0.9em; border-radius: 8px; width: auto; }

        #toastContainer { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .toast { padding: 12px 20px; border-radius: 25px; color: white; font-weight: 500; box-shadow: 0 3px 10px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: all 0.4s ease; }
        .toast.is-visible { opacity: 1; transform: translateY(0); }
        .toast-info { background-color: var(--dark-color); }
        .toast-success { background-color: var(--secondary-color); }
        .toast-error { background-color: var(--danger-color); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; z-index: 1000; }
        .modal-container { background: white; padding: 25px; border-radius: 16px; width: 95%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.is-active { opacity: 1; visibility: visible; }
        .modal-overlay.is-active .modal-container { transform: scale(1); }
        .modal-title { font-size: 1.5em; text-align: center; margin-top: 0; }
        .modal-actions { display: flex; flex-direction: column; gap: 15px; margin-top: 25px; }
        #cropperModalContainer { display: flex; flex-direction: column; gap: 15px; }
        #cropperImageContainer { max-height: 60vh; }
        #cropperImage { max-width: 100%; }
        .cropper-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .loader { display: inline-block; border: 4px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    
    <header class="app-header" id="appHeader" style="display:none;">
        <div>
            <h1 class="app-header-title">Gestor de Reportes</h1>
            <div id="headerSubtitle" class="app-header-subtitle"></div>
        </div>
        <button id="changeTypeBtn">Cambiar Tipo</button>
    </header>

    <div class="app-container">
        <!-- SELECCIÓN DE TIPO -->
        <div class="card" id="typeSelectionCard">
            <h2 class="card-title"><i class="fa-solid fa-file-circle-plus"></i>REPORTES PDF</h2>
            <div class="type-selection-grid">
                <div class="type-tile" data-type="RECONEXION">
                    <div class="icon"><i class="fa-solid fa-plug-circle-check"></i></div>
                    <h3>Reconexión</h3>
                    <p>Genera reportes de reconexiones a papel.</p>
                </div>
                <div class="type-tile" data-type="CHARLA SEMANAL">
                    <div class="icon" style="color: #198754;"><i class="fa-solid fa-people-group"></i></div>
                    <h3>Charla Semanal</h3>
                    <p>Crea informes de charlas de seguridad semanales.</p>
                </div>
                 <div class="type-tile" data-type="FORMACIONES">
                    <div class="icon" style="color: #6c757d;"><i class="fa-solid fa-chalkboard-user"></i></div>
                    <h3>Formaciones</h3>
                    <p>Documenta formaciones y capacitaciones.</p>
                </div>
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL -->
        <div id="mainContent" style="display: none;">
            <div class="card" id="prepareCard">
                <h2 class="card-title"><i class="fa-solid fa-list-check"></i>1. Preparar Documento</h2>
                <div id="charlaInputs" class="input-group" style="display:none;">
                    <label>Rango de fechas para la charla:</label>
                    <div class="input-group-grid"> <input type="date" id="charlaStartDate"> <input type="date" id="charlaEndDate"> </div>
                </div>
                <div id="formacionesInputs" class="input-group" style="display:none;">
                     <label>Datos de la Formación:</label>
                     <div class="input-group-grid"> <input type="number" id="formacionNumero" placeholder="3 Números"> <input type="text" id="formacionTexto" placeholder="Texto adicional"> </div>
                </div>
                <div class="input-group">
                    <label for="pdfNameInput">Nombre del Reporte:</label>
                    <input type="text" id="pdfNameInput" placeholder="Se generará automáticamente...">
                </div>
                <div class="input-group-grid">
                    <button class="btn btn-primary" id="captureBtn"><i class="fa-solid fa-camera"></i> Tomar Foto</button>
                    <button class="btn btn-primary" id="selectBtn"><i class="fa-solid fa-images"></i> Seleccionar</button>
                    <input type="file" id="fileInput" accept="image/*" style="display:none;">
                </div>
                <div id="filePreviewContainer">
                    <h4 style="margin-top:25px; margin-bottom:15px; font-weight:600;">Imágenes en cola:</h4>
                    <div class="file-preview-grid" id="filePreviewGrid"></div>
                    <button class="btn btn-danger" id="clearSelectionBtn" style="margin-top: 20px;"><i class="fa-solid fa-trash-can"></i> Limpiar Selección</button>
                </div>
            </div>

            <div class="card" id="generateCard">
                 <h2 class="card-title"><i class="fa-solid fa-paper-plane"></i>2. Generar y Enviar</h2>
                 <button class="btn btn-secondary btn-full" id="generateButton" disabled> <i class="fa-solid fa-file-pdf"></i> Generar PDF </button>
                 <div id="status" style="text-align: center; margin-top: 15px; font-weight: 600;"></div>
            </div>

            <div class="card" id="historyCard">
                <h2 class="card-title"><i class="fa-solid fa-clock-rotate-left"></i>Historial de Reportes</h2>
                <div id="historyContainer"><p>Cargando...</p></div>
            </div>
        </div>
    </div>
    
    <!-- MODALES -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal-container">
            <h3 class="modal-title">¡PDF Generado!</h3>
            <p style="text-align:center; color: #555;">Elige cómo quieres compartirlo:</p>
            <div class="modal-actions">
                <button class="btn btn-primary" id="modalNativeShare"><i class="fa-solid fa-share-nodes"></i> Compartir...</button>
                <button class="btn btn-secondary" id="modalWhatsapp"><i class="fa-brands fa-whatsapp"></i> Enviar a WhatsApp</button>
                <button class="btn" style="background-color: #0072C6; color: white;" id="modalEmail"><i class="fa-solid fa-envelope"></i> Enviar Correo (Reconexión)</button>
                <button class="btn" style="background-color: #6c757d; color: white;" id="modalDownload"><i class="fa-solid fa-download"></i> Solo Descargar</button>
            </div>
            <button class="btn btn-danger" style="margin-top: 15px;" id="modalClose">Cerrar</button>
        </div>
    </div>
    <div class="modal-overlay" id="cropperModal">
        <div class="modal-container">
            <h3 class="modal-title">Recortar Imagen</h3>
            <div id="cropperModalContainer">
                <div id="cropperImageContainer"><img id="cropperImage" src=""></div>
                <div class="cropper-actions">
                    <button id="confirmCropBtn" class="btn btn-secondary"><i class="fa-solid fa-check"></i> Confirmar</button>
                    <button id="cancelCropBtn" class="btn btn-danger"><i class="fa-solid fa-times"></i> Cancelar</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toastContainer"></div>

    <script>
        // --- ESTADO GLOBAL Y CONFIGURACIÓN ---
        const CORREO_DESTINO = "cgo.cens@consorcioci.co";
        const DB_NAME = "ReconexionesDB_v3";
        const DB_VERSION = 2; 
        const STORE_NAME = "pdfs";
        const { jsPDF } = window.jspdf;
        let db;
        let selectedFiles = []; 
        let cropperInstance = null;
        let generatedPdfBlob = null;
        let generatedPdfName = '';
        let currentDocumentType = null;
        let nativeShareSupported = false;

        // --- SELECTORES DE ELEMENTOS DOM ---
        const dom = {
            appHeader: document.getElementById('appHeader'),
            headerSubtitle: document.getElementById('headerSubtitle'),
            typeSelectionCard: document.getElementById('typeSelectionCard'),
            typeTiles: document.querySelectorAll('.type-tile'),
            mainContent: document.getElementById('mainContent'),
            changeTypeBtn: document.getElementById('changeTypeBtn'),
            charlaInputs: document.getElementById('charlaInputs'),
            charlaStartDate: document.getElementById('charlaStartDate'),
            charlaEndDate: document.getElementById('charlaEndDate'),
            formacionesInputs: document.getElementById('formacionesInputs'),
            formacionNumero: document.getElementById('formacionNumero'),
            formacionTexto: document.getElementById('formacionTexto'),
            captureBtn: document.getElementById('captureBtn'),
            selectBtn: document.getElementById('selectBtn'),
            clearSelectionBtn: document.getElementById('clearSelectionBtn'),
            fileInput: document.getElementById('fileInput'),
            filePreviewContainer: document.getElementById('filePreviewContainer'),
            filePreviewGrid: document.getElementById('filePreviewGrid'),
            pdfNameInput: document.getElementById('pdfNameInput'),
            generateButton: document.getElementById('generateButton'),
            statusDiv: document.getElementById('status'),
            historyContainer: document.getElementById('historyContainer'),
            shareModal: document.getElementById('shareModal'),
            cropperModal: document.getElementById('cropperModal'),
            cropperImage: document.getElementById('cropperImage'),
            modalNativeShare: document.getElementById('modalNativeShare'),
            modalWhatsapp: document.getElementById('modalWhatsapp'),
            modalEmail: document.getElementById('modalEmail'),
            modalDownload: document.getElementById('modalDownload'),
            modalClose: document.getElementById('modalClose'),
            confirmCropBtn: document.getElementById('confirmCropBtn'),
            cancelCropBtn: document.getElementById('cancelCropBtn'),
        };

        // --- FUNCIÓN DE INICIO ---
        async function initializeApp() {
            nativeShareSupported = !!(navigator.share && navigator.canShare);
            setupEventListeners();
            
            try {
                await initDB();
                await mostrarHistorial();
            } catch (error) {
                console.error("Error al inicializar la BD:", error);
                dom.historyContainer.innerHTML = `<p style="color:red;">Error fatal al cargar el historial.</p>`;
            }
            
            showTypeSelection();
            updateSelectedFilesUI();
        }
        document.addEventListener('DOMContentLoaded', initializeApp);


        // --- ASIGNACIÓN DE EVENTOS ---
        function setupEventListeners() {
            dom.typeTiles.forEach(tile => tile.addEventListener('click', () => showMainContent(tile.dataset.type))); 
            dom.changeTypeBtn.addEventListener('click', showTypeSelection); 
            
            dom.charlaStartDate.addEventListener('change', updateCharlaName); 
            dom.charlaEndDate.addEventListener('change', updateCharlaName); 
            dom.formacionNumero.addEventListener('input', updateFormacionesName); 
            dom.formacionTexto.addEventListener('input', updateFormacionesName);
            
            dom.captureBtn.addEventListener('click', () => { dom.fileInput.capture = 'environment'; dom.fileInput.click(); }); 
            dom.selectBtn.addEventListener('click', () => { dom.fileInput.removeAttribute('capture'); dom.fileInput.click(); });
            dom.fileInput.addEventListener('change', handleFileSelectionForCropper);
            
            dom.clearSelectionBtn.addEventListener('click', () => { 
                selectedFiles = []; 
                dom.fileInput.value = ''; 
                updateSelectedFilesUI(); 
            });
            dom.filePreviewGrid.addEventListener('click', handleRemovePreview);
            
            dom.generateButton.addEventListener('click', generatePdf);
            
            // Listeners de modales
            const closeModal = () => dom.shareModal.classList.remove('is-active');
            dom.modalNativeShare.addEventListener('click', () => triggerNativeShare(generatedPdfBlob, generatedPdfName).finally(closeModal));
            dom.modalWhatsapp.addEventListener('click', () => { window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(`Se comparte el documento: ${generatedPdfName}`)}`, '_blank'); setTimeout(() => downloadBlob(generatedPdfBlob, `${generatedPdfName}.pdf`), 500); closeModal(); });
            dom.modalEmail.addEventListener('click', () => { const cc = "diego.medina@inmel.co,edgar.mendoza@inmel.co,NELSON.CARVAJAL@cens.com.co", asunto = encodeURIComponent("RECONEXIONES A PAPEL"), cuerpo = encodeURIComponent(`Buen día.\n\nAdjunto archivo correspondiente a reconexiones en papel ejecutadas...\n\nCordialmente...`); window.open(`mailto:${CORREO_DESTINO}?cc=${cc}&subject=${asunto}&body=${cuerpo}`, '_blank'); setTimeout(() => downloadBlob(generatedPdfBlob, `${generatedPdfName}.pdf`), 500); closeModal(); });
            dom.modalDownload.addEventListener('click', () => { downloadBlob(generatedPdfBlob, `${generatedPdfName}.pdf`); closeModal(); });
            dom.modalClose.addEventListener('click', closeModal);
            dom.confirmCropBtn.addEventListener('click', confirmCrop);
            dom.cancelCropBtn.addEventListener('click', closeCropper);
            dom.historyContainer.addEventListener('click', handleHistoryActions);
        }

        // --- FLUJO DE LA INTERFAZ ---
        function showTypeSelection() {
            dom.mainContent.style.display = 'none';
            dom.appHeader.style.display = 'none';
            dom.typeSelectionCard.style.display = 'block';
            currentDocumentType = null;
            if(selectedFiles.length > 0) dom.clearSelectionBtn.click();
            dom.pdfNameInput.value = '';
        }

        function showMainContent(type) {
            currentDocumentType = type;
            const typeNombres = { 'RECONEXION': 'Reconexión', 'CHARLA SEMANAL': 'Charla Semanal', 'FORMACIONES': 'Formaciones' };
            dom.headerSubtitle.textContent = `Tipo de Reporte: ${typeNombres[type]}`;
            dom.typeSelectionCard.style.display = 'none';
            dom.mainContent.style.display = 'block';
            dom.appHeader.style.display = 'flex';
            dom.charlaInputs.style.display = 'none';
            dom.formacionesInputs.style.display = 'none';
            switch(type) {
                case 'RECONEXION':
                    const hoy = new Date().toLocaleDateString('es-CO');
                    dom.pdfNameInput.value = `RECONEXION A PAPEL PAMPLONA ${hoy}`;
                    break;
                case 'CHARLA SEMANAL':
                    dom.charlaInputs.style.display = 'block';
                    updateCharlaName();
                    break;
                case 'FORMACIONES':
                    dom.formacionesInputs.style.display = 'block';
                    updateFormacionesName();
                    break;
            }
        }

        // --- LÓGICA DE BASE DE DATOS E HISTORIAL ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => reject("Error al abrir IndexedDB.");
                request.onsuccess = (event) => { db = event.target.result; resolve(); };
                request.onupgradeneeded = (event) => {
                    let db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        store.createIndex('fecha', 'fecha', { unique: false });
                        store.createIndex('tipo', 'tipo', { unique: false });
                    }
                };
            });
        }
        
        async function mostrarHistorial() {
            try {
                await limpiarHistorialAntiguo();
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onerror = () => { dom.historyContainer.innerHTML = "<p>Error al cargar el historial.</p>"; };
                request.onsuccess = (event) => {
                    const historial = event.target.result;
                    if (historial.length === 0) {
                        dom.historyContainer.innerHTML = "<p>No hay reportes guardados.</p>";
                        return;
                    }
                    renderHistory(historial);
                };
            } catch (err) {
                console.error("Error en mostrarHistorial:", err);
                dom.historyContainer.innerHTML = "<p>No se pudo procesar el historial.</p>";
            }
        }

        function renderHistory(historial) {
            const grouped = historial.reduce((acc, item) => { const tipo = item.tipo || 'Sin Categoría', fecha = new Date(item.fecha), monthKey = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`, dayKey = `${monthKey}-${String(fecha.getDate()).padStart(2, '0')}`; if (!acc[tipo]) acc[tipo] = {}; if (!acc[tipo][monthKey]) acc[tipo][monthKey] = {}; if (!acc[tipo][monthKey][dayKey]) acc[tipo][monthKey][dayKey] = []; acc[tipo][monthKey][dayKey].push(item); return acc; }, {});
            let html = '<div class="history-group">';
            for (const tipo in grouped) {
                const tipoNombres = { 'RECONEXION': 'Reconexiones', 'CHARLA SEMANAL': 'Charlas Semanales', 'FORMACIONES': 'Formaciones' }, tipoNombre = tipoNombres[tipo] || tipo, totalItemsPorTipo = Object.values(grouped[tipo]).flatMap(days => Object.values(days)).flat().length;
                html += `<details><summary>${tipoNombre} (${totalItemsPorTipo})</summary><div class="history-group-nested">`;
                const meses = grouped[tipo], sortedMonthKeys = Object.keys(meses).sort().reverse();
                for(const monthKey of sortedMonthKeys) {
                    const totalItemsPorMes = Object.values(meses[monthKey]).flat().length, [year, month] = monthKey.split('-'), monthName = new Date(year, month - 1, 1).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                    html += `<details><summary>${monthName.charAt(0).toUpperCase() + monthName.slice(1)} (${totalItemsPorMes})</summary><div class="history-group-nested">`;
                    const dias = meses[monthKey], sortedDayKeys = Object.keys(dias).sort().reverse();
                    for(const dayKey of sortedDayKeys) {
                        const itemsDelDia = dias[dayKey], [dYear, dMonth, dDay] = dayKey.split('-'), dayName = new Date(dYear, dMonth-1, dDay).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' });
                        html += `<details><summary>${dayName.charAt(0).toUpperCase() + dayName.slice(1)} (${itemsDelDia.length})</summary><div class="history-item-container">`;
                        html += itemsDelDia.sort((a,b) => new Date(b.fecha) - new Date(a.fecha)).map(item => `<div class="history-item"><div class="history-info"><span class="name">${item.nombre}</span><span class="date">${new Date(item.fecha).toLocaleString('es-ES', { dateStyle: 'medium', timeStyle: 'short'})}</span></div><div class="history-actions">${nativeShareSupported ? `<button class="btn history-share-btn" data-id="${item.id}"><i class="fa-solid fa-share-nodes"></i></button>` : ''}<button class="btn history-dl-btn" data-id="${item.id}" style="background-color:#6c757d;color:white;"><i class="fa-solid fa-download"></i></button></div></div>`).join('');
                        html += `</div></details>`;
                    }
                    html += `</div></details>`;
                }
                html += `</div></details>`;
            }
            html += '</div>';
            dom.historyContainer.innerHTML = html;
        }

        function handleHistoryActions(event) {
            const button = event.target.closest('.history-dl-btn, .history-share-btn');
            if (!button) return;
            const id = Number(button.dataset.id);
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(id);
            request.onsuccess = (e) => {
                const record = e.target.result;
                if (!record || !record.pdfBlob) return;
                if (button.classList.contains('history-dl-btn')) {
                    downloadBlob(record.pdfBlob, `${record.nombre}.pdf`);
                } else if (button.classList.contains('history-share-btn')) {
                    triggerNativeShare(record.pdfBlob, record.nombre);
                }
            };
        }
        
        // --- CÓDIGO RESTANTE (RECORTADOR, PDF, ETC) ---
        // Estas funciones son independientes y no tienen cambios
        function handleFileSelectionForCropper(e) { const f = e.target.files; if (f && f.length > 0) { if (selectedFiles.length >= 10) { showToast("Máximo 10 imágenes permitidas.", 'error'); return; } openCropper(f[0]); } }
        function openCropper(file) { const reader = new FileReader(); reader.onload = (e) => { dom.cropperImage.src = e.target.result; dom.cropperModal.classList.add('is-active'); cropperInstance = new Cropper(dom.cropperImage, { aspectRatio: 0, viewMode: 1, responsive: true, background: false, autoCropArea: 0.9 }); }; reader.readAsDataURL(file); }
        function confirmCrop() { if (!cropperInstance) return; cropperInstance.getCroppedCanvas({ width: 1200, imageSmoothingEnabled: true, imageSmoothingQuality: 'high' }).toBlob(blob => { const newFile = new File([blob], `cropped-${Date.now()}.jpg`, { type: 'image/jpeg' }); selectedFiles.push(newFile); updateSelectedFilesUI(); closeCropper(); }, 'image/jpeg', 0.9); }
        function closeCropper() { if (cropperInstance) cropperInstance.destroy(); cropperInstance = null; dom.cropperModal.classList.remove('is-active'); dom.fileInput.value = ''; }
        function updateSelectedFilesUI() {
            if (selectedFiles.length === 0) { dom.filePreviewContainer.style.display = 'none'; dom.generateButton.disabled = true; } 
            else { dom.filePreviewContainer.style.display = 'block'; dom.filePreviewGrid.innerHTML = ''; selectedFiles.forEach((file, index) => { const item = document.createElement('div'); item.className = 'preview-item'; const img = document.createElement('img'); img.src = URL.createObjectURL(file); img.onload = () => URL.revokeObjectURL(img.src); const btn = document.createElement('button'); btn.className = 'remove-btn'; btn.innerHTML = '<i class="fa-solid fa-times"></i>'; btn.dataset.index = index; item.appendChild(img); item.appendChild(btn); dom.filePreviewGrid.appendChild(item); }); dom.generateButton.disabled = false; }
        }
        function handleRemovePreview(e) { const btn = e.target.closest('.remove-btn'); if (btn) { const index = parseInt(btn.dataset.index, 10); selectedFiles.splice(index, 1); updateSelectedFilesUI(); } }
        async function generatePdf() { if (!dom.pdfNameInput.value.trim() || dom.pdfNameInput.value.includes('(selecciona') || dom.pdfNameInput.value.includes('XXX')) { showToast("Completa los datos para el nombre del reporte.", 'error'); return; } dom.generateButton.disabled = true; dom.generateButton.innerHTML = '<span class="loader"></span> Procesando...'; dom.statusDiv.textContent = 'Creando PDF...'; try { const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' }); for (let i = 0; i < selectedFiles.length; i++) { dom.statusDiv.textContent = `Agregando imagen ${i + 1} de ${selectedFiles.length}...`; const imageData = await readFileAsDataURL(selectedFiles[i]), imgProps = await getImageProperties(imageData), { pdfWidth, pdfHeight } = { pdfWidth: pdf.internal.pageSize.getWidth(), pdfHeight: pdf.internal.pageSize.getHeight() }, margin = 15, ratio = Math.min((pdfWidth - margin * 2) / imgProps.width, (pdfHeight - margin * 2) / imgProps.height), [imgWidth, imgHeight] = [imgProps.width * ratio, imgProps.height * ratio], [x, y] = [(pdfWidth - imgWidth) / 2, (pdfHeight - imgHeight) / 2]; if (i > 0) pdf.addPage(); pdf.addImage(imageData, 'JPEG', x, y, imgWidth, imgHeight); } generatedPdfName = dom.pdfNameInput.value.trim(); generatedPdfBlob = pdf.output('blob'); await agregarAlHistorial(generatedPdfName, generatedPdfBlob, currentDocumentType); await mostrarHistorial(); dom.statusDiv.textContent = "¡PDF Listo!"; showShareOptionsModal(); } catch (e) { console.error("Error al generar PDF:", e); dom.statusDiv.textContent = "Error al generar el PDF."; showToast("Ocurrió un error al procesar las imágenes.", 'error'); } finally { dom.generateButton.disabled = false; dom.generateButton.innerHTML = '<i class="fa-solid fa-file-pdf"></i> Generar PDF'; } }
        function showShareOptionsModal() { dom.modalNativeShare.style.display = nativeShareSupported ? 'flex' : 'none'; dom.modalEmail.style.display = currentDocumentType === 'RECONEXION' ? 'flex' : 'none'; dom.shareModal.classList.add('is-active'); }
        async function triggerNativeShare(blob, name) { const file = new File([blob], `${name}.pdf`, { type: 'application/pdf' }); try { await navigator.share({ files: [file], title: name, text: `Se adjunta el documento: ${name}` }); } catch (e) { if (e.name !== 'AbortError') console.error('Error al compartir:', e); } }
        const updateCharlaName = () => { if (dom.charlaStartDate.value && dom.charlaEndDate.value) { const s = new Date(dom.charlaStartDate.value + 'T00:00:00'), e = new Date(dom.charlaEndDate.value + 'T00:00:00'); dom.pdfNameInput.value = `CHARLA SEMANAL del ${s.toLocaleDateString('es-CO', { day: '2-digit', month: 'long' })} al ${e.toLocaleDateString('es-CO', { day: '2-digit', month: 'long', year: 'numeric' })}`; } else { dom.pdfNameInput.value = 'CHARLA SEMANAL (selecciona fechas)'; } };
        const updateFormacionesName = () => { dom.pdfNameInput.value = `PAM${dom.formacionNumero.value || 'XXX'}-${dom.formacionTexto.value || 'descripción'}`; };
        function showToast(message, type = 'info') { const container = document.getElementById('toastContainer'), toast = document.createElement('div'); toast.className = `toast toast-${type}`; toast.textContent = message; container.appendChild(toast); setTimeout(() => toast.classList.add('is-visible'), 10); setTimeout(() => { toast.classList.remove('is-visible'); toast.addEventListener('transitionend', () => toast.remove()); }, 3000); }
        function downloadBlob(blob, filename) { const url = URL.createObjectURL(blob), a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
        function agregarAlHistorial(nombre, pdfBlob, tipo) { const transaction = db.transaction([STORE_NAME], 'readwrite'), store = transaction.objectStore(STORE_NAME); return new Promise((resolve, reject) => { const request = store.add({ nombre, fecha: new Date(), pdfBlob, tipo }); request.onsuccess = resolve; request.onerror = reject; }); }
        function limpiarHistorialAntiguo() { return new Promise((resolve, reject) => { const tresMesesAtras = new Date(); tresMesesAtras.setMonth(tresMesesAtras.getMonth() - 3); const transaction = db.transaction([STORE_NAME], 'readwrite'); const store = transaction.objectStore(STORE_NAME); const index = store.index('fecha'); const request = index.openCursor(IDBKeyRange.upperBound(tresMesesAtras)); request.onsuccess = e => { const cursor = e.target.result; if (cursor) { cursor.delete(); cursor.continue(); } else { resolve(); } }; request.onerror = reject; }); }
        const readFileAsDataURL = file => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(file); });
        const getImageProperties = src => new Promise((resolve, reject) => { const img = new Image(); img.onload = () => resolve({ width: img.width, height: img.height }); img.onerror = reject; img.src = src; });
    </script>
</body>
</html>
